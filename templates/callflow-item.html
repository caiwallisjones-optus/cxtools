{% extends 'base.html' %}
{% import 'macro.jinja' as common %}
{# Inputs:  render_template('CallFlow-list.html',  items = list, action_item, action_responses) item,action_item,responses #}

{% macro def_RenderInput(input_type,action_name,default_value) %}

{% if input_type == "HOO_LOOKUP" %}
  <input type="text" class="form-control" name="{{action_name}}" list="{{input_type}}" value = "{{default_value}}" />
  <datalist id="{{input_type}}">
  {% for data_item in data_model.GetHooList()%}
    <option>{{data_item['name']}}</option>
  {% endfor %}
  </datalist>
{% elif input_type == "WAV_LOOKUP" %}
  <input type="text" class="form-control" name="{{action_name}}" list="{{input_type}}" value = "{{default_value}}" />
  <datalist id="{{input_type}}">
  {% for data_item in data_model.GetUserWavList()%}
    <option>{{data_item['name']}}</option>
  {% endfor %}
  </datalist>
{% elif input_type == "SKILL_LOOKUP" %}
  <input type="text" class="form-control" name="{{action_name}}" list="{{input_type}}" value = "{{default_value}}" />
  <datalist id="{{input_type}}">
    {% for data_item in data_model.GetSkillList()%}
    <option>{{data_item['name']}}</option>
    {% endfor %}
  </datalist>
{% elif input_type == "ACTION_LOOKUP" %}
  <select class="form-control" id="CallFlowaction" name="{{action_name}}" >
    {% for data_item in data_model.GetMenuActions()%}
    {% set data_line = data_item.split('|')%}
    <option value={{data_line[0]}}>{{data_line[1]}}</option>
    {% endfor %}
  </select>   
{% else %}
  <input type="text" class="form-control" id="{{action_name}}" name="{{action_name}}" value="{{default_value}}">
{% endif %}
{% endmacro %}


{% macro def_RenderActionResponsePanel(action_item,action_responses, submitPrefix = "action_") %}
<div class="panel panel-primary clearfix">
  <div class="panel-heading clearfix form-inline">TODO:ADD BREADCRUMBS HERE > {{action_item[3]}}
  </div>
  <div class="panel-body">
  <label>Action Type: {{action_item[4]}}</label><br>
  <input type="hidden" name="action_type" value="{{ action_item[4] }}"></input>
  <label>Action Name:</label> 
  {{def_RenderInput("TEXT","action_name",action_item[3])}}
  <br>
    {%for param in data_model.GetActionParams(action_item[4])%}
      {%set line = param.split('|')%}
      {%set responsetext = action_item[5].split(',') %}
      <label>{{ line[0] }}:</label> 
      {{def_RenderInput(line[1],"action_param_"+ loop.index0|string,responsetext[loop.index0])}}
    {%endfor%}

  <br>
  {% set responses = data_model.GetActionResponsesForAction(action_item[4]) %}
  {% if responses != None and responses|length > 1 %}

  <div class="panel panel-default">
    <div class="panel-heading clearfix form-inline">Next Step
      <div class="pull-right">
      <select class="form-control gap-3" id="{{submitPrefix}}State" name="{{submitPrefix}}response_new" >
        {%for option in responses %}
        <option value="{{option}}">{{option}}</option>
        {%endfor%}
      </select>
      <button type="submit" class="form-control btn btn-primary btn-sm" name="action" value="{{submitPrefix}}response_new">  Add  </button>
    </div>
      {% endif %}
    </div>
    <div class="panel-body">
  <br>
  {%if action_responses == None or action_responses is not defined%}**No default next actions - select add to create next action**
  {%else %}
    {% for element in action_responses %}
      <div class="form-group form-inline">
        <label>{{element[3]}}</label>
        {%if element[4] == None%}
        <button type="submit" class="form-control btn btn-primary btn-sm pull-right" name="action" value="{{submitPrefix}}response_create_{{element[0]}}">Create</button>
        {%else%}
        <button type="submit" class="form-control btn btn-primary btn-sm pull-right" name="action" value="{{submitPrefix}}response_select_{{element[0]}}" >Select</button>
        {%endif%}
      </div>
    {%endfor%}
  {% endif %}
  </div>
</div>
</div>
</div>
{% endmacro %}


{% macro def_RenderCallFlowAction(item) %}
  <div class="panel panel-primary">
    <div class="panel-heading">..</div>
    <div class="panel-body">
<div class="form-inline">
        <div class="form-group">
<div class="input-group">
  <div>
  {{def_RenderInput("ACTION_LOOKUP","action_type","")}}  &nbsp;&nbsp;&nbsp;
  <button type="submit" class="form-control btn btn-primary btn-med" name="action"
      value="action_new">New</button>
    </div>
</div>
</div>
      </div>
    </div>
  </div>
<br>
<br>
{% endmacro %}

{% block content %}
{% if item == None %}
<h2>Call Flow</h2>
{%else%}
<h2>Call Flow</h2>
{% endif %}
<!--header for queue information-->
{% if errMsg%}
<!--We had an error the last time we told the user to do this - display and retry-->
<p class="justify-content-lg-center btn-warning">{{errMsg}}</p>
{% endif %}
<form method='post'>
  {{ common.def_RenderActions(item,'item_') }}
  <div>
    <input type="hidden" name="id" value="{{ item[0] }}"></input>
    <input type="hidden" name="action_id" value="{{ action_item[0] }}"></input>    
    
  </div>
  <div class="form-group">
    <input type="hidden" name="id" value="{{ item[0] }}" ></input>
    {%if action_item == None%}
    <input type="hidden" name="action_id" value="0" ></input>
    {%else%}
    <input type="hidden" name="action_id" value="{{action_item.action_id}}" ></input>
    {%endif%}
    <label for="name">Name:</label>
    <input type="text" class="form-control" id="name" name="name" value="{{item[2]}}">
  </div>
  <div class="form-group">
    <label for="description">Description:</label>
    <input type="text" class="form-control" id="description" name="description" value="{{item[3]}}">
  </div>
  {% if item != None %} {#  #}
    <label for="description">Call Flow actions and configuration:</label>
    {%if (action_item == None) or (action_item[4] == '') %}
      {{ def_RenderCallFlowAction(item) }}
    {%else%}
      {{ def_RenderActionResponsePanel(action_item,action_responses) }}
    {%endif%}
  {%endif%}
</form>
{% endblock %}